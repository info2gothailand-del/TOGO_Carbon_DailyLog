<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>TOGO Daily Log - Pro Version (Sheet Matched)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script crossorigin src="https://unpkg.com/react@18.3.1/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{ --bg:#f8fafc;--card:#ffffff;--muted:#64748b;--text:#1e293b;--border:#e2e8f0;--accent:#0f172a;--good:#10b981;--blue:#2563eb;--warn:#f59e0b;--bad:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);font-size:14px}
    .container{max-width:1200px;margin:20px auto;padding:0 15px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:15px;box-shadow:0 1px 3px rgba(0,0,0,0.02)}
    .head{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:15px;margin-bottom:15px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 16px;border-radius:12px;border:1px solid var(--accent);background:var(--accent);color:#fff;cursor:pointer;font-weight:600;transition:0.2s;}
    .btn.sec{background:#fff;color:var(--text);border-color:var(--border)}
    .btn.blue{background:var(--blue);border-color:var(--blue)}
    .btn.bad{background:var(--bad);border-color:var(--bad)}
    .btn.good{background:var(--good);border-color:var(--good)}
    .btn:disabled{opacity:0.4;cursor:not-allowed}
    input,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;font-size:14px}

    table{width:100%;border-collapse:collapse;min-width:1100px}
    th,td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:center}
    th{background:#f1f5f9;font-size:12px;color:var(--muted);text-transform:uppercase}

    .kpis { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    .kpi { background: #fff; border: 1px solid var(--border); border-radius: 14px; padding: 15px; position: relative; overflow: hidden; }
    .kpi .val { font-size: 22px; font-weight: 800; position: relative; z-index: 1; }
    .kpi::after { content: attr(data-icon); position: absolute; right: 5px; bottom: -10px; font-size: 45px; opacity: 0.12; filter: grayscale(0.5); }

    .badge{padding:4px 10px;border-radius:999px;font-size:11px;font-weight:bold;display:inline-block}
    .bg-good{color:var(--good);background:#ecfdf5}
    .bg-warn{color:var(--warn);background:#fffbeb}
    .bg-bad{color:var(--bad);background:#fef2f2}

    .modalBack{position:fixed;inset:0;background:rgba(15,23,42,0.6);display:flex;align-items:center;justify-content:center;padding:15px;z-index:1000;backdrop-filter:blur(4px)}
    .modal{max-width:720px;width:100%;background:#fff;border-radius:20px;padding:25px;max-height:90vh;overflow-y:auto}
    .radioRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .radioBtn{display:flex;align-items:center;gap:6px;padding:10px 16px;border:1px solid var(--border);border-radius:12px;cursor:pointer;user-select:none}

    .admin-panel{background:#eff6ff;border:2px dashed var(--blue);margin-bottom:15px;animation:fadeIn 0.3s}
    @keyframes fadeIn { from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:translateY(0)} }
    .rowhint{color:var(--muted);font-size:12px}

    /* ‚úÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ô‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô + ‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡πÅ‡∏Å‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î) */
    table input{ padding:6px 8px; font-size:13px; }
    th, td{ padding:6px 6px; white-space:nowrap; }
    .badge{ white-space:nowrap; min-width:84px; text-align:center; }
    td:nth-child(1){min-width:110px;} /* ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà */
    td:nth-child(2), td:nth-child(3), td:nth-child(4), td:nth-child(5), td:nth-child(6){min-width:90px;}
  </style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
  const { useState, useMemo, useEffect } = React;

  // --- Constants (Sheet Matched) ---
  const ITEMS_DAILY = [
    {k:"d1", t:"‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"},
    {k:"d2", t:"‡∏û‡∏∑‡πâ‡∏ô‡πÅ‡∏´‡πâ‡∏á/‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏£‡∏±‡πà‡∏ß"},
    {k:"d3", t:"‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"},
    {k:"d4", t:"‡∏™‡∏†‡∏≤‡∏û‡∏ù‡∏≤/‡∏õ‡∏£‡∏∞‡∏ï‡∏π/‡∏à‡∏∏‡∏î‡∏•‡πá‡∏≠‡∏Å"},
    {k:"d5", t:"‡πÄ‡∏™‡∏µ‡∏¢‡∏á/‡∏™‡∏±‡πà‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥"},
    {k:"d6", t:"‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ Alarm"}
  ];

  const STATUS_STD = [
    {v:"ok", l:"‡∏õ‡∏Å‡∏ï‡∏¥"},
    {v:"problem", l:"‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤"},
    {v:"na", l:"‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏ß‡∏à"}
  ];

  const STATUS_FILL = [
    {v:"done", l:"‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß"},
    {v:"problem", l:"‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤"},
    {v:"not", l:"‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡∏¥‡∏°"}
  ];
  const STATUS_CHANGE = [
    {v:"done", l:"‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß"},
    {v:"problem", l:"‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤"},
    {v:"not", l:"‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô"}
  ];

  const ITEMS_M = [
    {k:"m1", t:"‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏£‡∏≠‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"},
    {k:"m2", t:"‡∏ô‡πá‡∏≠‡∏ï/‡πÇ‡∏ö‡∏•‡∏ï‡πå‡πÑ‡∏°‡πà‡∏´‡∏•‡∏ß‡∏°"},
    {k:"m3", t:"‡∏Ñ‡∏£‡∏≤‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡∏à‡∏≤‡∏£‡∏∞‡∏ö‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥"},
    {k:"m4", t:"‡∏™‡∏≤‡∏¢‡πÑ‡∏ü/‡∏õ‡∏•‡∏±‡πä‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥"},
    {k:"m5", t:"‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏Æ‡∏î‡∏£‡∏≠‡∏•‡∏¥‡∏Å"},
    {k:"m6", t:"‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÑ‡∏Æ‡∏î‡∏£‡∏≠‡∏•‡∏¥‡∏Å", opts: STATUS_FILL},
    {k:"m7", t:"‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏£‡∏∞‡∏ö‡∏µ", opts: STATUS_FILL},
    {k:"m8", t:"‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ô‡πâ‡∏≥‡πÉ‡∏ô‡∏ñ‡∏±‡∏á‡∏´‡∏°‡∏±‡∏Å", opts: STATUS_CHANGE},
    {k:"m9", t:"‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ô‡πâ‡∏≥‡πÉ‡∏ô‡∏ñ‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡∏•‡∏¥‡πà‡∏ô", opts: STATUS_CHANGE}
  ];

  // --- Helpers ---
  const num = (v, d=2) => new Intl.NumberFormat("th-TH",{maximumFractionDigits:d}).format(v||0);
  const getToday = () => new Date(Date.now() - new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
  const safeParse = (k, f) => { try { return JSON.parse(localStorage.getItem(k) || f); } catch { return JSON.parse(f); } };
  const uid = () => (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : Math.random().toString(36).slice(2);

  const allChecked = (obj, items) => items.every(it => !!obj?.[it.k]);
  const anyProblem = (obj) => Object.values(obj || {}).includes("problem");

  const daysBetween = (isoA, isoB) => {
    const a = new Date(isoA), b = new Date(isoB);
    const diff = a.getTime() - b.getTime();
    return Math.floor(diff / 86400000);
  };

  function App(){
    // --- State ---
    const [isAdmin, setIsAdmin] = useState(false);
    const [machineId, setMachineId] = useState(() => localStorage.getItem("tg_machineId") || "TG1000S-A01");
    const [endpoint, setEndpoint] = useState(() => localStorage.getItem("tg_endpoint") || "");
    const [apiToken, setApiToken] = useState(() => localStorage.getItem("tg_token") || "");

    const [rows, setRows] = useState(() => safeParse("tg_rows_v3_sheet", "[]"));
    const [selId, setSelId] = useState(null);

    const [mCk, setMCk] = useState(() => safeParse("tg_mck_15_30_v1", "{}"));
    const [mSavedAtISO, setMSavedAtISO] = useState(() => localStorage.getItem("tg_m_savedAtISO") || "");

    const [showDaily, setShowDaily] = useState(false);
    const [showM, setShowM] = useState(false);

    const [syncing, setSyncing] = useState(false);

    // --- Persist ---
    useEffect(() => {
      localStorage.setItem("tg_machineId", machineId);
      localStorage.setItem("tg_endpoint", endpoint);
      localStorage.setItem("tg_token", apiToken);
      localStorage.setItem("tg_rows_v3_sheet", JSON.stringify(rows));
      localStorage.setItem("tg_mck_15_30_v1", JSON.stringify(mCk));
      localStorage.setItem("tg_m_savedAtISO", mSavedAtISO || "");
    }, [machineId, endpoint, apiToken, rows, mCk, mSavedAtISO]);

    // init selection
    useEffect(() => {
      if (!rows.length) {
        addRow();
      } else if (!selId) {
        setSelId(rows[0].id);
      }
      // eslint-disable-next-line
    }, []);

    // --- Derived: Overdue 15 days? ---
    const nowISO = new Date().toISOString();
    const oldestRowDate = useMemo(() => {
      if (!rows.length) return getToday();
      const ds = rows.map(r => String(r.date || "").slice(0,10)).filter(Boolean).sort();
      return ds[0] || getToday();
    }, [rows]);

    const mComplete = useMemo(() => allChecked(mCk, ITEMS_M), [mCk]);
    const baseISO = mSavedAtISO || (oldestRowDate ? `${oldestRowDate}T00:00:00.000Z` : "");
    const mOverdue = useMemo(() => {
      if (!baseISO) return false;
      return daysBetween(nowISO, baseISO) >= 15 && !mComplete;
    }, [nowISO, baseISO, mComplete]);

    // --- Summary ---
    const computeSummary = (row) => {
      const dOK = row.dailyComplete && allChecked(row.dailyCk, ITEMS_DAILY);
      const mHasAny = Object.keys(mCk || {}).length > 0;
      const mAll = allChecked(mCk, ITEMS_M);
      const hasProb = anyProblem(row.dailyCk) || anyProblem(mCk);

      if (hasProb) return "‚ö† ‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤";
      if (dOK && (!mHasAny || mAll)) return "‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
      if (!dOK) return "‚è≥ ‡∏£‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ";
      return "‚è≥ ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö";
    };

    // ‚úÖ helper: ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥ (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
    const findRowByDate = (isoDate, exceptId) => {
      const d = String(isoDate || "").slice(0,10);
      if (!d) return null;
      return rows.find(r => r.id !== exceptId && String(r.date || "").slice(0,10) === d) || null;
    };

    // --- Actions ---
    const addRow = () => {
      const today = getToday();
      const dup = rows.find(r => String(r.date || "").slice(0,10) === today);

      // ‚úÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡πÅ‡∏ñ‡∏ß‡∏ô‡∏±‡πâ‡∏ô
      if (dup) {
        alert("‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÅ‡∏ñ‡∏ß‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚úÖ ‡∏à‡∏∞‡∏û‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡∏ô‡∏±‡πâ‡∏ô");
        setSelId(dup.id);
        return;
      }

      const nr = {
        id: uid(),
        date: today,
        kwh: "",
        humidityPct: "",
        soilOutKg: "",
        wasteInKg: "",
        supplementaryKg: "",
        note: "",
        dailyCk: {},
        dailyComplete: false,
        savedAt: "",
        syncedAt: ""
      };
      setRows(prev => [...prev, nr]);
      setSelId(nr.id);
    };

    const patchRow = (id, patch) => setRows(prev =>
      prev.map(r => {
        if (r.id !== id) return r;
        const next = { ...r, ...patch };

        const core = ["date","kwh","humidityPct","soilOutKg","wasteInKg","supplementaryKg","note","dailyCk"];
        const changedCore = core.some(k => k in patch);
        if (changedCore && r.syncedAt) next.syncedAt = ""; // dirty
        return next;
      })
    );

    // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ‡∏ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥ ‚Üí ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≥
    const handleDateChange = (rowId, newDate) => {
      const dup = findRowByDate(newDate, rowId);
      if (dup) {
        alert("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚úÖ ‡∏à‡∏∞‡∏û‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡∏ô‡∏±‡πâ‡∏ô");
        setSelId(dup.id);
        return;
      }
      patchRow(rowId, { date: newDate });
    };

    const deleteRow = (id) => {
      if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) return;
      const next = rows.filter(r => r.id !== id);
      setRows(next);
      if (selId === id) setSelId(next.length ? next[0].id : null);
    };

    // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å = ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏ï‡πâ‡∏≠‡∏á d1‚Äìd6 ‡∏Ñ‡∏£‡∏ö) + ‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ + ‡∏Å‡∏±‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥
    const handleSaveDaily = () => {
      const row = rows.find(r => r.id === selId);
      if (!row) return;

      if (!allChecked(row.dailyCk, ITEMS_DAILY)) {
        return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠");
      }

      // ‚úÖ ‡∏Å‡∏±‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™‡∏´‡∏•‡∏∏‡∏î)
      const dup = findRowByDate(row.date, selId);
      if (dup) {
        alert("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚úÖ ‡∏à‡∏∞‡∏û‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡∏ô‡∏±‡πâ‡∏ô");
        setSelId(dup.id);
        return;
      }

      const now = new Date().toLocaleString("th-TH");
      setRows(prev => prev.map(r => {
        if (r.id !== selId) return r;
        return { ...r, dailyComplete: true, savedAt: now, syncedAt: "" }; // ‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ
      }));

      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ (‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô Cloud ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Sync Cloud)");
    };

    const handleSaveM = () => {
      if (!allChecked(mCk, ITEMS_M)) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏•‡∏¥‡∏™‡∏ï‡πå 15‚Äì30 ‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠");
      setMSavedAtISO(new Date().toISOString());
      setShowM(false);
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡∏•‡∏¥‡∏™‡∏ï‡πå 15‚Äì30 ‡∏ß‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
    };

    // --- Sync ---
    const syncNow = async (currentRows = rows) => {
      if (!endpoint) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL Address ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Admin");
      if (!apiToken) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Password ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Admin");

      setSyncing(true);
      try {
        const dailyToSend = currentRows.filter(r => r.dailyComplete && !r.syncedAt);
        if (!dailyToSend.length) {
          alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á");
          return;
        }

        const payload = dailyToSend.map(r => ({
          machineId,
          date: String(r.date || "").slice(0,10),
          kwh: +r.kwh || 0,
          humidity: (r.humidityPct === "" ? "" : +r.humidityPct),
          soilOut: +r.soilOutKg || 0,
          wasteIn: +r.wasteInKg || 0,
          supplementaryKg: (r.supplementaryKg === "" ? "" : +r.supplementaryKg),
          note: r.note || "",

          d1: r.dailyCk?.d1 || "-",
          d2: r.dailyCk?.d2 || "-",
          d3: r.dailyCk?.d3 || "-",
          d4: r.dailyCk?.d4 || "-",
          d5: r.dailyCk?.d5 || "-",
          d6: r.dailyCk?.d6 || "-",

          m1: mCk?.m1 || "-",
          m2: mCk?.m2 || "-",
          m3: mCk?.m3 || "-",
          m4: mCk?.m4 || "-",
          m5: mCk?.m5 || "-",
          m6: mCk?.m6 || "-",
          m7: mCk?.m7 || "-",
          m8: mCk?.m8 || "-",
          m9: mCk?.m9 || "-",

          checkSummary: computeSummary(r),
          savedAt: r.savedAt || ""
        }));

        await fetch(`${endpoint}?token=${encodeURIComponent(apiToken)}`, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });

        const now = new Date().toLocaleString("th-TH");
        setRows(prev => prev.map(r => dailyToSend.some(x => x.id === r.id) ? { ...r, syncedAt: now } : r));
        alert(`‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${dailyToSend.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß`);

      } catch (e) {
        console.error(e);
        alert("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πá‡∏Ñ Console / ‡πÄ‡∏ô‡πá‡∏ï / URL)");
      } finally {
        setSyncing(false);
      }
    };

    // --- Export Excel ---
    const handleExportExcel = () => {
      const data = rows.map(r => ({
        "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": machineId,
        "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà": String(r.date || "").slice(0,10),
        "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÑ‡∏ü (kWh)": r.kwh,
        "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)": r.humidityPct,
        "‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏î‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å (kg)": r.soilOutKg,
        "‡∏Ç‡∏¢‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤ (kg)": r.wasteInKg,
        "‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏†‡∏≤‡∏û (kg)": r.supplementaryKg,
        "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏": r.note || "",
        "d1": r.dailyCk?.d1 || "-",
        "d2": r.dailyCk?.d2 || "-",
        "d3": r.dailyCk?.d3 || "-",
        "d4": r.dailyCk?.d4 || "-",
        "d5": r.dailyCk?.d5 || "-",
        "d6": r.dailyCk?.d6 || "-",
        "m1": mCk?.m1 || "-",
        "m2": mCk?.m2 || "-",
        "m3": mCk?.m3 || "-",
        "m4": mCk?.m4 || "-",
        "m5": mCk?.m5 || "-",
        "m6": mCk?.m6 || "-",
        "m7": mCk?.m7 || "-",
        "m8": mCk?.m8 || "-",
        "m9": mCk?.m9 || "-",
        "Checklist ‡∏™‡∏£‡∏∏‡∏õ": computeSummary(r),
        "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠": r.savedAt || "",
        "Sync ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î": r.syncedAt || ""
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "DailyLog");
      XLSX.writeFile(wb, `TOGO_DailyLog_${getToday()}.xlsx`);
    };

    // Admin unlock (3 ‡∏Ñ‡∏•‡∏¥‡∏Å)
    const handleTitleClick = (e) => {
      if (e.detail === 3) {
        const pass = prompt("Admin Password:");
        if (pass === "TG123") setIsAdmin(true);
      }
    };

    // --- KPIs ---
    const summary = useMemo(() => {
      const d = rows.reduce((a, b) => ({
        w: a.w + (+b.wasteInKg || 0),
        s: a.s + (+b.soilOutKg || 0),
        k: a.k + (+b.kwh || 0)
      }), {w:0, s:0, k:0});
      const net = Math.max(0, (d.w * 2.1974) - (d.k * 0.5986)) / 1000;
      return { ...d, net, trees: net * 24.56 };
    }, [rows]);

    const selRow = rows.find(r => r.id === selId);

    const statusBadge = (r) => {
      if (r.syncedAt) return <span className="badge bg-good">‚òÅÔ∏è ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>;
      if (r.dailyComplete) return <span className="badge bg-warn">‚è≥ ‡∏£‡∏≠‡∏™‡πà‡∏á</span>;
      return <span className="badge bg-warn">üìù ‡∏£‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ</span>;
    };

    const mBtnClass = mComplete ? "btn good" : (mOverdue ? "btn bad" : "btn sec");
    const mBtnText = mComplete ? "‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏•‡∏¥‡∏™ 15‚Äì30 ‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß" : (mOverdue ? "‚ö† ‡πÄ‡∏ä‡πá‡∏Ñ‡∏•‡∏¥‡∏™ 15‚Äì30 ‡∏ß‡∏±‡∏ô (‡πÄ‡∏Å‡∏¥‡∏ô 15 ‡∏ß‡∏±‡∏ô)" : "üß∞ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏•‡∏¥‡∏™ 15‚Äì30 ‡∏ß‡∏±‡∏ô");

    return (
      <div className="container">
        {isAdmin && (
          <div className="card admin-panel">
            <div className="head">
              <h3 style={{margin:0}}>‚öôÔ∏è Admin Config</h3>
              <button className="btn bad" onClick={()=>setIsAdmin(false)}>Close Admin</button>
            </div>
            <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(250px, 1fr))', gap:15}}>
              <div><label>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label><input value={machineId} onChange={e=>setMachineId(e.target.value)} /></div>

              {/* ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ */}
              <div><label>URL Address</label><input value={endpoint} placeholder="https://script.google.com/macros/s/.../exec" onChange={e=>setEndpoint(e.target.value)} /></div>
              <div><label>Password</label><input type="password" value={apiToken} placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Apps Script" onChange={e=>setApiToken(e.target.value)} /></div>

              <div className="rowhint">* ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö no-cors (‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)</div>
            </div>
          </div>
        )}

        <div className="card">
          <div className="head">
            <div onClick={handleTitleClick} style={{cursor:'pointer', userSelect:'none'}}>
              <h1 style={{margin:0}}>‚ôªÔ∏è TOGO Daily Log</h1>
              <small>ID: {machineId} (‡πÅ‡∏ï‡∏∞ 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)</small>
            </div>
            <div className="toolbar">
              <button className="btn sec" onClick={handleExportExcel}>üì• Export Excel</button>
              <button className="btn blue" onClick={() => syncNow()} disabled={syncing}>
                {syncing ? "‚åõ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á..." : "‚òÅÔ∏è Sync Cloud"}
              </button>
            </div>
          </div>

          <div className="kpis">
            <div className="kpi" data-icon="üçå"><small>üçå ‡∏Ç‡∏¢‡∏∞‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå‡∏™‡∏∞‡∏™‡∏° (kg)</small><div className="val">{num(summary.w)}</div></div>
            <div className="kpi" data-icon="‚ö°"><small>‚ö° ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÑ‡∏ü (kWh)</small><div className="val">{num(summary.k)}</div></div>
            <div className="kpi" data-icon="üå±"><small>üå± ‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏î‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ (kg)</small><div className="val">{num(summary.s)}</div></div>
            <div className="kpi" data-icon="üåç"><small>üåç ‡∏•‡∏î‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏≠‡∏ô (tCO2e)</small><div className="val" style={{color:'var(--good)'}}>{num(summary.net,3)}</div></div>
            <div className="kpi" data-icon="üå≥"><small>üå≥ ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ (‡∏ï‡πâ‡∏ô)</small><div className="val" style={{color:'var(--blue)'}}>{num(summary.trees,0)}</div></div>
          </div>
        </div>

        <div className="card" style={{overflowX:'auto'}}>
          <div className="head">
            <h3 style={{margin:0}}>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
            <div className="toolbar">
              <button className={`btn ${selRow?.dailyComplete ? 'good' : 'bad'}`} onClick={()=>setShowDaily(true)} disabled={!selId}>
                {selRow?.dailyComplete ? '‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‚ö† ‡πÄ‡∏ä‡πá‡∏Ñ‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô'}
              </button>

              <button className={mBtnClass} onClick={()=>setShowM(true)}>
                {mBtnText}
              </button>

              <button className="btn blue" onClick={handleSaveDaily} disabled={!selId}>
                üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
              </button>

              <button className="btn" onClick={addRow}>+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                <th>‚ö° ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÑ‡∏ü(kWh)</th>
                <th>üíß ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô(%)</th>
                <th>üå± ‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏î‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å(kg)</th>
                <th>üçå ‡∏Ç‡∏¢‡∏∞‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå‡πÄ‡∏Ç‡πâ‡∏≤(kg)</th>
                <th>üåø ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏†‡∏≤‡∏û(kg)</th>
                <th>‡∏™‡∏£‡∏∏‡∏õ</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th>‡∏•‡∏ö</th>
              </tr>
            </thead>
            <tbody>
              {rows.map(r => {
                const s = computeSummary(r);
                const sClass = s.includes("‚ö†") ? "bg-bad" : (s.includes("‚úÖ") ? "bg-good" : "bg-warn");
                return (
                  <tr key={r.id} onClick={()=>setSelId(r.id)} style={{background: selId===r.id ? '#eff6ff' : 'transparent', cursor:'pointer'}}>
                    <td><input type="date" value={r.date} onChange={e=>handleDateChange(r.id, e.target.value)} /></td>
                    <td><input type="number" value={r.kwh} onChange={e=>patchRow(r.id, {kwh:e.target.value})} /></td>
                    <td><input type="number" value={r.humidityPct} onChange={e=>patchRow(r.id, {humidityPct:e.target.value})} /></td>
                    <td><input type="number" value={r.soilOutKg} onChange={e=>patchRow(r.id, {soilOutKg:e.target.value})} /></td>
                    <td><input type="number" value={r.wasteInKg} onChange={e=>patchRow(r.id, {wasteInKg:e.target.value})} /></td>
                    <td><input type="number" value={r.supplementaryKg} onChange={e=>patchRow(r.id, {supplementaryKg:e.target.value})} /></td>
                    <td><span className={`badge ${sClass}`}>{s}</span></td>
                    <td>{statusBadge(r)}</td>
                    <td>
                      <button className="btn sec" onClick={(e)=>{e.stopPropagation(); deleteRow(r.id);}}>üóëÔ∏è</button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>

          <div className="rowhint" style={{marginTop:10}}>
            * ‡∏Å‡∏±‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡πÅ‡∏•‡πâ‡∏ß: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ã‡πâ‡∏≥ ‡∏à‡∏∞‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏¥‡∏° / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ d1‚Äìd6 ‡∏Ñ‡∏£‡∏ö
          </div>
        </div>

        {/* Modal: Daily Checklist */}
        {showDaily && selRow && (
          <div className="modalBack" onClick={()=>setShowDaily(false)}>
            <div className="modal" onClick={e=>e.stopPropagation()}>
              <div className="head">
                <h2 style={{margin:0}}>üìù Checklist ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô: {selRow.date}</h2>
                <button className="btn sec" onClick={()=>setShowDaily(false)}>X</button>
              </div>

              <div className="rowhint" style={{marginBottom:10}}>
                * ‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Å‡∏î ‚Äúüíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Äù ‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å
              </div>

              {ITEMS_DAILY.map(it => (
                <div key={it.k} style={{marginBottom:15}}>
                  <b>{it.t}</b>
                  <div className="radioRow">
                    {STATUS_STD.map(s => (
                      <label key={s.v} className="radioBtn"
                        style={{
                          background: selRow.dailyCk?.[it.k]===s.v ? '#dbeafe' : '',
                          borderColor: selRow.dailyCk?.[it.k]===s.v ? 'var(--blue)' : ''
                        }}
                      >
                        <input
                          type="radio"
                          checked={selRow.dailyCk?.[it.k]===s.v}
                          onChange={()=>patchRow(selId, { dailyCk: { ...(selRow.dailyCk||{}), [it.k]: s.v } })}
                        />
                        {s.l}
                      </label>
                    ))}
                  </div>
                </div>
              ))}

              <div style={{marginTop:10}}>
                <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</label>
                <textarea rows="3" value={selRow.note} onChange={e=>patchRow(selId, {note: e.target.value})}></textarea>
              </div>

              <button className="btn sec" style={{width:'100%', marginTop:15, padding:15}} onClick={()=>setShowDaily(false)}>
                ‡∏õ‡∏¥‡∏î
              </button>
            </div>
          </div>
        )}

        {/* Modal: 15‚Äì30 day Checklist */}
        {showM && (
          <div className="modalBack" onClick={()=>setShowM(false)}>
            <div className="modal" onClick={e=>e.stopPropagation()}>
              <div className="head">
                <h2 style={{margin:0}}>üß∞ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏•‡∏¥‡∏™ ‡∏ó‡∏∏‡∏Å 15‚Äì30 ‡∏ß‡∏±‡∏ô</h2>
                <button className="btn sec" onClick={()=>setShowM(false)}>X</button>
              </div>

              <div className="rowhint" style={{marginBottom:10}}>
                ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (m1‚Äìm9) / ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: {mSavedAtISO ? new Date(mSavedAtISO).toLocaleString("th-TH") : "-"}
              </div>

              {ITEMS_M.map(it => {
                const opts = it.opts || STATUS_STD;
                return (
                  <div key={it.k} style={{marginBottom:15}}>
                    <b>{it.t}</b>
                    <div className="radioRow">
                      {opts.map(s => (
                        <label key={s.v} className="radioBtn"
                          style={{
                            background: mCk?.[it.k]===s.v ? '#dbeafe' : '',
                            borderColor: mCk?.[it.k]===s.v ? 'var(--blue)' : ''
                          }}
                        >
                          <input
                            type="radio"
                            checked={mCk?.[it.k]===s.v}
                            onChange={()=>setMCk(prev => ({ ...(prev||{}), [it.k]: s.v }))}
                          />
                          {s.l}
                        </label>
                      ))}
                    </div>
                  </div>
                );
              })}

              <button className="btn blue" style={{width:'100%', marginTop:10, padding:15}} onClick={handleSaveM}>
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡∏•‡∏¥‡∏™‡∏ï‡πå 15‚Äì30 ‡∏ß‡∏±‡∏ô
              </button>
            </div>
          </div>
        )}
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
